<!DOCTYPE html>
<html>
<head>
    <title>PDF Contextual RAG Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #0f172a; color: white; }
        .sidebar { background: #1e293b; height: 100vh; padding: 20px; }
        .chat-area { height: 70vh; overflow-y: auto; padding: 20px; }
        .message { padding: 12px 16px; border-radius: 12px; margin-bottom: 12px; max-width: 75%; }
        .user { background: #2563eb; margin-left: auto; }
        .bot { background: #334155; }
        .source-box {
            margin-top: 8px;
            padding: 8px 10px;
            background: #1e293b;
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .response-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        .file-item { margin-bottom: 12px; }
        .status-badge { font-size: 0.75rem; }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-3 sidebar">

            <h5>Document Upload</h5>

            <input type="file"
                   multiple
                   accept="application/pdf"
                   class="form-control mb-2"
                   id="pdfFiles">

            <button class="btn btn-primary w-100 mb-3"
                    onclick="uploadFiles()">
                Upload Documents
            </button>

            <div id="fileStatusContainer"></div>

            <hr class="border-secondary">

            <button class="btn btn-outline-danger w-100"
                    onclick="clearChat()">
                Clear Chat
            </button>

        </div>

        <!-- Chat -->
        <div class="col-9 d-flex flex-column">

            <div class="chat-area flex-grow-1" id="chat"></div>

            <div class="input-group p-3 border-top border-secondary">
                <input type="text"
                       id="question"
                       class="form-control"
                       placeholder="Ask a question..."
                       disabled>

                <button class="btn btn-success"
                        id="sendBtn"
                        onclick="askQuestion()"
                        disabled>
                    Send
                </button>
            </div>

        </div>

    </div>
</div>

<!-- Ready Modal -->
<div class="modal fade" id="readyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Documents Indexed</h5>
            </div>
            <div class="modal-body">
                All selected documents have been successfully indexed.
                You may now start chatting.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button"
                        class="btn btn-primary"
                        data-bs-dismiss="modal">
                    Start Chatting
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const chat = document.getElementById("chat");
    const fileContainer = document.getElementById("fileStatusContainer");
    const questionInput = document.getElementById("question");
    const sendBtn = document.getElementById("sendBtn");

    let indexedFiles = [];

    function createFileStatusUI(fileName) {

        const div = document.createElement("div");
        div.className = "file-item";
        div.id = `file-${fileName}`;

        div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${fileName}</span>
            <span class="badge bg-secondary status-badge"
                  id="status-${fileName}">
                Uploading
            </span>
        </div>
        <div class="progress mt-1">
            <div id="progress-${fileName}"
                 class="progress-bar"
                 style="width:0%">0%</div>
        </div>
        <button class="btn btn-sm btn-danger mt-1"
                onclick="removeFile('${fileName}')"
                disabled
                id="remove-${fileName}">
            Remove
        </button>
    `;

        fileContainer.appendChild(div);
    }

    async function uploadFiles() {

        const files = document.getElementById("pdfFiles").files;

        if (!files.length) {
            alert("Please select PDF files.");
            return;
        }

        fileContainer.innerHTML = "";
        indexedFiles = [];

        const formData = new FormData();

        for (let file of files) {

            if (file.type !== "application/pdf") {
                alert("Only PDF files allowed.");
                return;
            }

            createFileStatusUI(file.name);
            formData.append("files", file);
        }

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload");

        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percent = Math.round((event.loaded / event.total) * 100);
                for (let file of files) {
                    const bar = document.getElementById(`progress-${file.name}`);
                    bar.style.width = percent + "%";
                    bar.innerText = percent + "%";
                }
            }
        };

        xhr.onload = function() {

            const response = JSON.parse(xhr.responseText);

            response.files.forEach(file => {

                indexedFiles.push(file.file_name);

                const status = document.getElementById(`status-${file.file_name}`);
                status.className = "badge bg-success status-badge";
                status.innerText = "Indexed";

                document.getElementById(`remove-${file.file_name}`).disabled = false;
            });

            enableChat();

            const modal = new bootstrap.Modal(document.getElementById('readyModal'));
            modal.show();
        };

        xhr.send(formData);
    }

    async function removeFile(fileName) {

        await fetch("/remove", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ file_name: fileName })
        });

        document.getElementById(`file-${fileName}`).remove();
        indexedFiles = indexedFiles.filter(f => f !== fileName);

        if (indexedFiles.length === 0) {
            disableChat();
        }
    }

    function enableChat() {
        questionInput.disabled = false;
        sendBtn.disabled = false;
    }

    function disableChat() {
        questionInput.disabled = true;
        sendBtn.disabled = true;
    }

    function addUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message user";
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function addBotMessage(answer, sources, responseTime) {

        const div = document.createElement("div");
        div.className = "message bot";

        div.innerHTML = `
        <div>${answer}</div>
        <div class="source-box">
            <strong>Sources:</strong><br>
            ${sources.map(s => "â€¢ " + s).join("<br>")}
        </div>
        <div class="response-time">
            Response time: ${responseTime}s
        </div>
    `;

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function askQuestion() {

        const question = questionInput.value.trim();
        if (!question) return;

        addUserMessage(question);
        questionInput.value = "";
        sendBtn.disabled = true;

        const response = await fetch("/ask?question=" + encodeURIComponent(question), {
            method: "POST"
        });

        const data = await response.json();

        addBotMessage(data.answer, data.sources, data.response_time);

        sendBtn.disabled = false;
    }

    function clearChat() {
        chat.innerHTML = "";
    }

    questionInput.addEventListener("keydown", function(e){
        if (e.key === "Enter") {
            e.preventDefault();
            askQuestion();
        }
    });

</script>

</body>
</html>
